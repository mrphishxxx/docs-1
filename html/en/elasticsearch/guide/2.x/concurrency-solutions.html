<!DOCTYPE html><html lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Solving Concurrency Issues
        | Elasticsearch: The Definitive Guide [2.x]
      | Elastic
    </title><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="Elasticsearch: The Definitive Guide [2.x]" /><link rel="up" href="relations.html" title="Handling Relationships" /><link rel="prev" href="denormalization-concurrency.html" title="Denormalization and Concurrency" /><link rel="next" href="nested-objects.html" title="Nested Objects" /><meta name="DC.type" content="Docs/Elasticsearch/Definitive Guide/2.x" /><meta http-equiv="content-type" content="text/html; charset=utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png?change=123"><link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png?change=123"><link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png?change=123"><link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png?change=123"><link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png?change=123"><link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png?change=123"><link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png?change=123"><link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png?change=123"><link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png?change=123"><link rel="icon" type="image/png" sizes="192x192" href="/android-icon-192x192.png?change=123"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png?change=123"><link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png?change=123"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png?change=123"><link rel="manifest" href="/manifest.json"><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><link rel="schema.DCTERMS" href="http://purl.org/dc/terms/"><meta name="description" content=""/><meta property="og:image" content="/static/img/cluster-small.png"/><link rel="shortcut icon" href="favicon.ico" type="image/x-icon"><link rel="icon" href="favicon.ico?change=123" type="image/x-icon"><link rel="apple-touch-icon-precomposed" sizes="64x64" href="favicon_64x64_16bit.png"><link rel="apple-touch-icon-precomposed" sizes="32x32" href="favicon_32x32.png"><link rel="apple-touch-icon-precomposed" sizes="16x16" href="favicon_16x16.png"><link href="/static/css/main.css" rel="stylesheet"> <!--[if lt IE 9]><script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script><script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script><![endif]--><link type="text/css" rel="stylesheet" href="/static/css/prettify.css"/><link type="text/css" rel="stylesheet" href="/static/css/guide.css"/><script type="text/javascript" src="/static/js/prettify.js"></script>
<link rel="stylesheet" type="text/css" href="styles.css" />

</head><body><script>dataLayer = [];</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-58RLH5" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
			new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
			j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
			'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
	})(window,document,'script','dataLayer','GTM-58RLH5');</script><header class="header-wrapper"><div class="navigation-wrapper"><div class="container"><nav class="navbar"><div class="navbar-mobile-header navbar-header mr-20 mr-xs-0"><div class="row hidden-sm hidden-md hidden-lg"><div class="col-xs-5 hidden-sm hidden-md hidden-lg"><div class="navbar-mobile-header-icon navbar-mobile-header-icon-out"><span></span><span></span><span></span></div> <a href="/learn" class="nav-title hidden-sm hidden-md hidden-lg m-l-10">Learn</a></div><div class="col-xs-2 text-center"><div class="navbar-brand" id="elastic"><h1> <a class="logo-m hidden-sm hidden-md hidden-lg" href="/"><img src="/assets/blt65c71c1236219a27/elastic-logo-mobile.svg" alt="elastic-logo-mobile"></a></h1></div></div><div class="col-xs-5 hidden-sm hidden-md hidden-lg text-right"><ul class="menu-m hidden-sm hidden-md hidden-lg"><li class=""><a class="icon-contact" href="/contact"></a></li><li id="searchbar"><a class="button icon" href="#"></a></li><li class="lang global-language"><a href="#">EN</a><ul class="language-list"><li><a href="/">English</a></li><li><a href="/fr/">français</a></li><li><a href="/de/">Deutsche</a></li><li><a href="/jp/">日本語</a></li><li><a href="/kr/">한국어</a></li></ul></li></ul></div></div><div class="navbar-brand hidden-xs" id="elastic"><h1> <a class="hidden-xs" id="elastic-logo" href="/"><img src="/assets/blt49aa5273c3bf983b/elastic-logo.svg" alt="elastic-logo"></a></h1></div></div><div class="collapse navbar-collapse mobile-inner-nav"><nav class="nav navbar-nav primary-nav-hover" id="nav"><ul><li> <a id="nav_products" class="  nav-item" href="/products">Products</a><div class="text-center quaternary-nav hidden-xs hover-nav"><div class="container"><div class="p-t-b-5"><ul class="list-inline nav-group"><li> <a href="/products/elasticsearch">Elasticsearch</a></li><li> <a href="/cloud">Elasticsearch as a Service</a></li><li> <a href="/products/logstash">Logstash</a></li><li> <a href="/products/kibana">Kibana</a></li><li> <a href="/products/beats">Beats</a></li><li> <a href="/products/watcher">Watcher</a></li><li> <a href="/products/shield">Shield</a></li><li> <a href="/products/marvel">Marvel</a></li><li> <a href="/products/graph">Graph</a></li><li> <a href="/products/reporting">Reporting</a></li><li> <a href="/products/hadoop">Hadoop</a></li></ul></div></div></div><ul class="hidden-sm hidden-md hidden-lg sub-navigation"><li><a id="nav_elasticsearch" href="/products/elasticsearch">Elasticsearch</a></li><li><a id="nav_elasticsearch as a service" href="/cloud">Elasticsearch as a Service</a></li><li><a id="nav_logstash" href="/products/logstash">Logstash</a></li><li><a id="nav_kibana" href="/products/kibana">Kibana</a></li><li><a id="nav_beats" href="/products/beats">Beats</a></li><li><a id="nav_watcher" href="/products/watcher">Watcher</a></li><li><a id="nav_shield" href="/products/shield">Shield</a></li><li><a id="nav_marvel" href="/products/marvel">Marvel</a></li><li><a id="nav_graph" href="/products/graph">Graph</a></li><li><a id="nav_reporting" href="/products/reporting">Reporting</a></li><li><a id="nav_hadoop" href="/products/hadoop">Hadoop</a></li></ul></li><li> <a id="nav_cloud" class="  nav-item" href="/cloud">Cloud</a><div class="text-center quaternary-nav hidden-xs hover-nav"><div class="container"><div class="p-t-b-5"><ul class="list-inline nav-group"><li> <a href="/cloud/subscriptions">Subscriptions</a></li><li> <a href="/cloud/pricing">Pricing</a></li><li> <a href="/cloud/support">Support</a></li></ul></div></div></div><ul class="hidden-sm hidden-md hidden-lg sub-navigation"><li><a id="nav_subscriptions" href="/cloud/subscriptions">Subscriptions</a></li><li><a id="nav_pricing" href="/cloud/pricing">Pricing</a></li><li><a id="nav_support" href="/cloud/support">Support</a></li></ul></li><li> <a id="nav_services" class="  nav-item" href="/services">Services</a></li><li> <a id="nav_customers" class="  nav-item" href="/use-cases">Customers</a></li><li> <a id="nav_learn" class="active nav-item" href="/learn">Learn</a><div class="text-center quaternary-nav hidden-xs hover-nav"><div class="container"><div class="p-t-b-5"><ul class="list-inline nav-group"><li> <a href="/community">Community</a></li><li> <a href="/guide">Docs</a></li><li> <a href="/blog">Blog</a></li><li> <a href="/videos">Videos</a></li><li> <a href="https://discuss.elastic.co/">Forums</a></li><li> <a href="/elasticon">Elastic{ON}</a></li></ul></div></div></div><ul class="hidden-sm hidden-md hidden-lg sub-navigation"><li><a id="nav_community" href="/community">Community</a></li><li><a id="nav_docs" href="/guide">Docs</a></li><li><a id="nav_blog" href="/blog">Blog</a></li><li><a id="nav_videos" href="/videos">Videos</a></li><li><a id="nav_forums" href="https://discuss.elastic.co/">Forums</a></li><li><a id="nav_elastic{on}" href="/elasticon">Elastic{ON}</a></li></ul></li></ul></nav><nav class="nav navbar-nav navbar-right hidden-xs"><ul><li class="hidden-xs hidden-sm"><a href="/downloads">Downloads</a></li><li class="hidden-xs hidden-md hidden-lg"><a class="icon-download" href="/downloads"></a></li><li class="hidden-xs hidden-sm"><a class="btn btn-primary btn-contact" href="/contact">Contact</a></li><li class="hidden-xs hidden-md hidden-lg"><a class="icon-contact" href="/contact"></a></li><li class="hidden-xs" id="searchbar"><a class="button icon" href="#"></a></li><li class="hidden-xs lang global-language"><a href="#">EN</a><ul class="language-list"><li><a class="" href="/">English</a></li><li><a class="" href="/fr/">français</a></li><li><a class="" href="/de/">Deutsche</a></li><li><a class="" href="/jp/">日本語</a></li><li><a class="" href="/kr/">한국어</a></li></ul></li></ul></nav></div></nav></div></div><div class="header-search-wrapper open-search"><div class="container"><div class="big-search"><i class="big-search-icon"></i><form id="searchfrm" name="searchForm" autocomplete="on" action="/search" method="get"><ul class="tags-wrapper"><li class="search-field"><input type="text" name="q" id="autocomplete" class="form-control global-input" autocomplete="off"></li></ul></form><a class="header-search-cancel" href="#"></a></div><div class="nav-auto-complete"></div></div></div><script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script><script>
$(window).load(function () {
  $(".navbar-mobile-header-icon").click(function(index){
    $('.navigation-wrapper').toggleClass('menu-overlay');
    $(this).toggleClass("navbar-mobile-header-icon-click navbar-mobile-header-icon-out");
    $(".mobile-inner-nav").slideToggle(500);
    $('.mobile-inner-nav .sub-navigation').css('display','none');
    $(".mobile-inner-nav a").each(function( index ) {
      $(this).css({'animation-delay': (index/25)+'s'});
    });
  });

  if($(window).width() < 769){
    $(".nav-item").click(function(e){
      e.preventDefault();
      var parent = $(this).parent();
      $('.sub-navigation',parent).slideToggle(250);
    })
  }
});
</script></header><style> 
    
      .m-shortcuts li a.m-search {
        background: url("/assets/blt78ef101d1c58b693/m-search-icon.png") no-repeat scroll center center rgba(0, 0, 0, 0);
        background-size: contain;}
    
      .m-shortcuts li a.m-docs {
        background: url("/assets/blt8c2d02cd42735ac3/m-guide-icon.png") no-repeat scroll center center rgba(0, 0, 0, 0);
        background-size: contain;}
    
      .m-shortcuts li a.m-contact {
        background: url("/assets/blte4c9f7f37cf09587/m-contact-icon.png") no-repeat scroll center center rgba(0, 0, 0, 0);
        background-size: contain;}
      
</style><script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script><script type="text/javascript" src="/static/js/nav-v5.js"></script><script type="text/javascript">
  $(document).ready( function(){
    $('.navbar-toggle').on('click', function(){
      $('.mobile-navigation, .menu-open').hide();
      $('.navigation-wrapper').addClass('mobile-navigation');
      $('.navbar').addClass('menu-open');
      $('.menu-close').show();
    });
    $('.menu-close').on('click', function(){
      $('.navigation-wrapper').removeClass('mobile-navigation');
      $('.navbar').removeClass('menu-open');
      $('.menu-close').hide();
      console.log("close");
    });

    // $(".mobile-inner-header-icon").click(function(){
    //   $(this).toggleClass("mobile-inner-header-icon-click mobile-inner-header-icon-out");
    //   $(".mobile-inner-nav").slideToggle(250);
    //   $(".navigation-wrapper").toggleClass('mobile-menu');
    //   if ($('.mobile-inner-header-icon-click').is(":visible")) {
    //     $('.menu-m').css({'display':"none"});
    //   }else{
    //     $('.menu-m').css({'display':"table-cell"});
    //   }
    // });
    // $(".mobile-inner-nav a").each(function( index ) {
    //   $( this ).css({'animation-delay': (index/10)+'s'});
    //   // $(".navigation-wrapper").removeClass('mobile-menu');
    // });
  });
</script><div class="tertiary-nav"><div class="container"><div class="p-t-b-13 bdr-btm-e7e7e7 clearfix"><div class="breadcrum-wrapper pull-left text-left"> <a href="/learn">Learn</a> <span>Docs</span></div></div></div></div><div class="nav-mobile-dropdown hidden-sm hidden-md hidden-lg clearfix"><div class="container"><div class="breadcrum-wrapper pull-left text-left"> <a class="dropdown-btn" href="javascript:void(0)">Docs</a></div></div></div><div class="main-container"><section id="content"><div class="content-wrapper">
            <div id="pageheader">
    <div class="container">
        <header>
            <h1><a href="/learn" title="Learn">Learn</a> |</h1>
            <h2><a href="/guide" title="Docs">Docs</a></h2>
        </header>
    </div>
</div>
<section id="guide">

            <!-- start body -->
<div class="breadcrumbs"><span class="breadcrumb-link"><a href="index.html">Elasticsearch: The Definitive Guide
      [2.x]
    </a></span> » <span class="breadcrumb-link"><a href="modeling-your-data.html">Modeling Your Data </a></span> » <span class="breadcrumb-link"><a href="relations.html">Handling Relationships</a></span> » <span class="breadcrumb-node">Solving Concurrency Issues</span></div><div class="navheader"><span class="prev"><a href="denormalization-concurrency.html">
              « 
              Denormalization and Concurrency</a>
           
        </span><span class="next">
           
          <a href="nested-objects.html">Nested Objects
               »
            </a></span></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="concurrency-solutions"></a>Solving Concurrency Issues<a href="https://github.com/elastic/elasticsearch-definitive-guide/edit/2.x/400_Relationships/26_Concurrency_solutions.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h2></div></div></div><p>The problem comes when we want to allow more than one person to rename files
or directories <span class="emphasis"><em>at the same time</em></span>. <a id="id-1.9.3.17.2.2" class="indexterm"></a>
<a id="id-1.9.3.17.2.3" class="indexterm"></a><a id="id-1.9.3.17.2.4" class="indexterm"></a>
<a id="id-1.9.3.17.2.5" class="indexterm"></a> Imagine that you rename the <code class="literal">/clinton</code>
directory, which contains hundreds of thousands of files.  Meanwhile, another
user renames the single file <code class="literal">/clinton/projects/elasticsearch/README.txt</code>.
That user’s change, although it started after yours, will probably finish more
quickly.</p><p>One of two things will happen:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
You have decided to use <code class="literal">version</code> numbers, in which case your mass rename
    will fail with a version conflict when it hits the renamed
    <code class="literal">README.txt</code> file.
</li><li class="listitem">
You didn’t use versioning, and your changes will overwrite the changes from
    the other user.
</li></ul></div><p>The problem is that Elasticsearch does not support
<a class="ulink" href="http://en.wikipedia.org/wiki/ACID_transactions" target="_top">ACID transactions</a>.<a id="id-1.9.3.17.5.2" class="indexterm"></a>  Changes to
individual documents are ACIDic, but not changes involving multiple documents.</p><p>If your main data store is a relational database, and Elasticsearch is simply
being used as a search engine<a id="id-1.9.3.17.6.1" class="indexterm"></a>
<a id="id-1.9.3.17.6.2" class="indexterm"></a> or as a way to improve performance, make
your changes in the database first and replicate those changes to
Elasticsearch after they have succeeded. This way, you benefit from the ACID
transactions available in the database, and all changes to Elasticsearch happen
in the right order. Concurrency is dealt with in the relational database.</p><p>If you are not using a relational store, these concurrency issues need to
be dealt with at the Elasticsearch level.  The following are three practical
solutions using Elasticsearch, all of which involve some form of locking:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Global Locking
</li><li class="listitem">
Document Locking
</li><li class="listitem">
Tree Locking
</li></ul></div><div class="tip admon"><div class="icon"><img alt="Tip" src="images/icons/tip.png" /></div><div class="admon_content"><p>The solutions described in this section could also be implemented by applying the same
principles while using an external system instead of Elasticsearch.</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="global-lock"></a>Global Locking<a href="https://github.com/elastic/elasticsearch-definitive-guide/edit/2.x/400_Relationships/26_Concurrency_solutions.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3></div></div></div><p>We can avoid concurrency issues completely by allowing only one process to
make changes at any time.<a id="id-1.9.3.17.10.2.1" class="indexterm"></a>
<a id="id-1.9.3.17.10.2.2" class="indexterm"></a><a id="id-1.9.3.17.10.2.3" class="indexterm"></a>  Most changes will involve only a few files and will
complete very quickly.  A rename of a top-level directory may block all other
changes for longer, but these are likely to be much less frequent.</p><p>Because document-level changes in Elasticsearch are ACIDic, we can use the
existence or absence of a document as a global lock.  To request a
lock, we try to <code class="literal">create</code> the global-lock document:</p><div class="pre_wrapper"><pre class="programlisting prettyprint lang-json">PUT /fs/lock/global/_create
{}</pre></div><p>If this <code class="literal">create</code> request fails with a conflict exception,
another process has already been granted the global lock and we will have to
try again later.  If it succeeds, we are now the proud owners of the
global lock and we can continue with our changes.  Once we are finished, we
must release the lock by deleting the global lock document:</p><div class="pre_wrapper"><pre class="programlisting prettyprint lang-json">DELETE /fs/lock/global</pre></div><p>Depending on how frequent changes are, and how long they take, a global lock
could restrict the performance of a system significantly.  We can increase
parallelism by making our locking more fine-grained.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="document-locking"></a>Document Locking<a href="https://github.com/elastic/elasticsearch-definitive-guide/edit/2.x/400_Relationships/26_Concurrency_solutions.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3></div></div></div><p>Instead of locking the whole filesystem, we could lock individual documents
by using the same technique as previously described.<a id="id-1.9.3.17.11.2.1" class="indexterm"></a>
<a id="id-1.9.3.17.11.2.2" class="indexterm"></a><a id="id-1.9.3.17.11.2.3" class="indexterm"></a>
We can use a <a class="link" href="scroll.html" title="Scroll">scrolled search</a> to retrieve all documents that would be affected by the change and
create a lock file for each one:</p><div class="pre_wrapper"><pre class="programlisting prettyprint lang-json">PUT /fs/lock/_bulk
{ "create": { "_id": 1}} <a id="CO261-1"></a><span><img src="images/icons/callouts/1.png" alt="" /></span>
{ "process_id": 123    } <a id="CO261-2"></a><span><img src="images/icons/callouts/2.png" alt="" /></span>
{ "create": { "_id": 2}}
{ "process_id": 123    }</pre></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO261-1"><span><img src="images/icons/callouts/1.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>
The ID of the <code class="literal">lock</code> document would be the same as the ID of  the file
    that should be locked.
</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO261-2"><span><img src="images/icons/callouts/2.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>
The <code class="literal">process_id</code> is a unique ID that represents the process that
    wants to perform the changes.
</p></td></tr></table></div><p>If some files are already locked, parts of the <code class="literal">bulk</code> request will fail and we
will have to try again.</p><p>Of course, if we try to lock <span class="emphasis"><em>all</em></span> of the files again, the <code class="literal">create</code> statements
that we used previously will fail for any file that is already locked by us!
Instead of a simple <code class="literal">create</code> statement, we need an <code class="literal">update</code> request with an
<code class="literal">upsert</code> parameter and this <code class="literal">script</code>:</p><div class="pre_wrapper"><pre class="programlisting prettyprint lang-groovy">if ( ctx._source.process_id != process_id ) { <a id="CO262-1"></a><span><img src="images/icons/callouts/1.png" alt="" /></span>
  assert false;  <a id="CO262-2"></a><span><img src="images/icons/callouts/2.png" alt="" /></span>
}
ctx.op = 'noop'; <a id="CO262-3"></a><span><img src="images/icons/callouts/3.png" alt="" /></span></pre></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO262-1"><span><img src="images/icons/callouts/1.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>
<code class="literal">process_id</code> is a parameter that we pass into the script.
</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO262-2"><span><img src="images/icons/callouts/2.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>
<code class="literal">assert false</code> will throw an exception, causing the update to fail.
</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO262-3"><span><img src="images/icons/callouts/3.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>
Changing the <code class="literal">op</code> from <code class="literal">update</code> to <code class="literal">noop</code> prevents the update request
    from making any changes, but still returns success.
</p></td></tr></table></div><p>The full <code class="literal">update</code> request looks like this:</p><div class="pre_wrapper"><pre class="programlisting prettyprint lang-json">POST /fs/lock/1/_update
{
  "upsert": { "process_id": 123 },
  "script": "if ( ctx._source.process_id != process_id )
  { assert false }; ctx.op = 'noop';"
  "params": {
    "process_id": 123
  }
}</pre></div><p>If the document doesn’t already exist, the <code class="literal">upsert</code> document is inserted—much
the same as the previous <code class="literal">create</code> request.  However, if the
document <span class="emphasis"><em>does</em></span> exist, the script looks at the <code class="literal">process_id</code> stored in the
document.  If the <code class="literal">process_id</code> matches, no update is performed (<code class="literal">noop</code>) but the
script returns successfully.  If it is different, <code class="literal">assert false</code> throws an exception
and you know that the lock has failed.</p><p>Once all locks have been successfully created, you can proceed with your changes.</p><p>Afterward, you must release all of the locks, which you can do by
retrieving all of the locked documents and performing a bulk delete:</p><div class="pre_wrapper"><pre class="programlisting prettyprint lang-json">POST /fs/_refresh <a id="CO263-1"></a><span><img src="images/icons/callouts/1.png" alt="" /></span>

GET /fs/lock/_search?scroll=1m <a id="CO263-2"></a><span><img src="images/icons/callouts/2.png" alt="" /></span>
{
    "sort" : ["_doc"],
    "query": {
        "match" : {
            "process_id" : 123
        }
    }
}

PUT /fs/lock/_bulk
{ "delete": { "_id": 1}}
{ "delete": { "_id": 2}}</pre></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO263-1"><span><img src="images/icons/callouts/1.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>
The <code class="literal">refresh</code> call ensures that all <code class="literal">lock</code> documents are visible to
    the search request.
</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO263-2"><span><img src="images/icons/callouts/2.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>
You can use a <a class="link" href="scroll.html" title="Scroll"><code class="literal">scroll</code></a> query when you need to retrieve large
numbers of results with a single search request.
</p></td></tr></table></div><p>Document-level locking enables fine-grained access control, but creating lock
files for millions of documents can be expensive.  In some cases,
you can achieve fine-grained locking with much less work, as shown in the
following directory tree scenario.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="tree-locking"></a>Tree Locking<a href="https://github.com/elastic/elasticsearch-definitive-guide/edit/2.x/400_Relationships/26_Concurrency_solutions.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3></div></div></div><p>Rather than locking every involved document as in the previous example, we
could lock just part of the directory tree.<a id="id-1.9.3.17.12.2.1" class="indexterm"></a>
<a id="id-1.9.3.17.12.2.2" class="indexterm"></a>  We will need exclusive access
to the file or directory that we want to rename, which can be achieved with an
<span class="emphasis"><em>exclusive lock</em></span> document:</p><div class="pre_wrapper"><pre class="programlisting prettyprint lang-json">{ "lock_type": "exclusive" }</pre></div><p>And we need shared locks on any parent directories, with a <span class="emphasis"><em>shared lock</em></span>
document:</p><div class="pre_wrapper"><pre class="programlisting prettyprint lang-json">{
  "lock_type":  "shared",
  "lock_count": 1 <a id="CO264-1"></a><span><img src="images/icons/callouts/1.png" alt="" /></span>
}</pre></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO264-1"><span><img src="images/icons/callouts/1.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>
The <code class="literal">lock_count</code> records the number of processes that hold a shared lock.
</p></td></tr></table></div><p>A process that wants to rename <code class="literal">/clinton/projects/elasticsearch/README.txt</code>
needs an <span class="emphasis"><em>exclusive</em></span> lock on that file, and a <span class="emphasis"><em>shared</em></span> lock on <code class="literal">/clinton</code>,
<code class="literal">/clinton/projects</code>, and <code class="literal">/clinton/projects/elasticsearch</code>.</p><p>A simple <code class="literal">create</code> request will suffice for the exclusive lock, but the shared
lock needs a scripted update to implement some extra logic:</p><div class="pre_wrapper"><pre class="programlisting prettyprint lang-groovy">if (ctx._source.lock_type == 'exclusive') {
  assert false; <a id="CO265-1"></a><span><img src="images/icons/callouts/1.png" alt="" /></span>
}
ctx._source.lock_count++ <a id="CO265-2"></a><span><img src="images/icons/callouts/2.png" alt="" /></span></pre></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO265-1"><span><img src="images/icons/callouts/1.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>
If the <code class="literal">lock_type</code> is <code class="literal">exclusive</code>, the <code class="literal">assert</code> statement will throw
    an exception, causing the update request to fail.
</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO265-2"><span><img src="images/icons/callouts/2.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>
Otherwise, we increment the <code class="literal">lock_count</code>.
</p></td></tr></table></div><p>This script handles the case where the <code class="literal">lock</code> document already exists, but we
will also need an <code class="literal">upsert</code> document to handle the case where it doesn’t exist
yet. The full update request is as follows:</p><div class="pre_wrapper"><pre class="programlisting prettyprint lang-json">POST /fs/lock/%2Fclinton/_update <a id="CO266-1"></a><span><img src="images/icons/callouts/1.png" alt="" /></span>
{
  "upsert": { <a id="CO266-2"></a><span><img src="images/icons/callouts/2.png" alt="" /></span>
    "lock_type":  "shared",
    "lock_count": 1
  },
  "script": "if (ctx._source.lock_type == 'exclusive')
  { assert false }; ctx._source.lock_count++"
}</pre></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO266-1"><span><img src="images/icons/callouts/1.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>
The ID of the document is <code class="literal">/clinton</code>, which is URL-encoded to <code class="literal">%2fclinton</code>.
</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO266-2"><span><img src="images/icons/callouts/2.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>
The <code class="literal">upsert</code> document will be inserted if the document does not already
    exist.
</p></td></tr></table></div><p>Once we succeed in gaining a shared lock on all of the parent directories, we
try to <code class="literal">create</code> an exclusive lock on the file itself:</p><div class="pre_wrapper"><pre class="programlisting prettyprint lang-json">PUT /fs/lock/%2Fclinton%2fprojects%2felasticsearch%2fREADME.txt/_create
{ "lock_type": "exclusive" }</pre></div><p>Now, if somebody else wants to rename the <code class="literal">/clinton</code> directory, they would
have to gain an exclusive lock on that path:</p><div class="pre_wrapper"><pre class="programlisting prettyprint lang-json">PUT /fs/lock/%2Fclinton/_create
{ "lock_type": "exclusive" }</pre></div><p>This request would fail because a <code class="literal">lock</code> document with the same ID already
exists. The other user would have to wait until our operation is done and we
have released our locks. The exclusive lock can just be deleted:</p><div class="pre_wrapper"><pre class="programlisting prettyprint lang-json">DELETE /fs/lock/%2Fclinton%2fprojects%2felasticsearch%2fREADME.txt</pre></div><p>The shared locks need another script that decrements the <code class="literal">lock_count</code> and, if
the count drops to zero, deletes the <code class="literal">lock</code> document:</p><div class="pre_wrapper"><pre class="programlisting prettyprint lang-groovy">if (--ctx._source.lock_count == 0) {
  ctx.op = 'delete' <a id="CO267-1"></a><span><img src="images/icons/callouts/1.png" alt="" /></span>
}</pre></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO267-1"><span><img src="images/icons/callouts/1.png" alt="" /></span></a> </p></td><td valign="top" align="left"><p>
Once the <code class="literal">lock_count</code> reaches <code class="literal">0</code>, the <code class="literal">ctx.op</code> is changed from <code class="literal">update</code>
    to <code class="literal">delete</code>.
</p></td></tr></table></div><p>This update request would need to be run for each parent directory in reverse
order, from longest to shortest:</p><div class="pre_wrapper"><pre class="programlisting prettyprint lang-json">POST /fs/lock/%2Fclinton%2fprojects%2felasticsearch/_update
{
  "script": "if (--ctx._source.lock_count == 0) { ctx.op = 'delete' } "
}</pre></div><p>Tree locking gives us fine-grained concurrency control with the minimum of
effort. Of course, it is not applicable to every situation—the data model
must have some sort of access path like the directory tree for it to work.</p><div class="note admon"><div class="icon"><img alt="Note" src="images/icons/note.png" /></div><div class="admon_content"><p>None of the three options—global, document, or tree locking—deals with
the thorniest problem associated with locking: what happens if the process
holding the lock dies?</p><p>The unexpected death of a process leaves us with two problems:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
How do we know that we can release the locks held by the dead process?
</li><li class="listitem">
How do we clean up the change that the dead process did not manage to complete?
</li></ul></div><p>These topics are beyond the scope of this book, but you will need to give them
some thought  if you decide to use locking.</p></div></div><p>While denormalization is a good choice for many projects, the need for locking
schemes can make for complicated implementations. Instead, Elasticsearch
provides two models that help us deal with related entities:
<span class="emphasis"><em>nested objects</em></span> and <span class="emphasis"><em>parent-child relationships</em></span>.</p></div></div><div class="navfooter"><span class="prev"><a href="denormalization-concurrency.html">
              « 
              Denormalization and Concurrency</a>
           
        </span><span class="next">
           
          <a href="nested-objects.html">Nested Objects
               »
            </a></span></div>
<!-- end body -->

            </section>

            <div id="rtpcontainer"
         class="col-xs-12 col-sm-4 col-md-4"><h3>Top Videos</h3><ul><li><a href="https://www.elastic.co/webinars/elasticsearch-2-0-overview?baymax=default&elektra=docs&storm=top-video">Getting Started</a></li><li><a href="http://www.elastic.co/webinars/elasticsearch-performance-optimization-tale-two-tickets/?elektra=docs">Scaling</a></li><li><a href="http://www.elastic.co/webinars/shield-securing-your-data-in-elasticsearch/?elektra=docs">Security</a></li></ul><hr/></div></div></div></section></div><script src="//app-lon02.marketo.com/js/forms2/js/forms2.min.js"></script><div class="subscribe-wrapper"><div class="container text-left"><div class="subscribe-title"><h5>Be in the know with the latest and greatest from Elastic.</h5></div><div class="subscribe-form"><form id="mktoForm_1398" class="mktoForm sb-form"></form><div class="form_thanks hide"><p>Thanks for subscribing! We'll keep you updated with new releases.</p></div></div></div></div><footer class="footer-wrapper"><div class="container"><div class="row footer-content"><div class="col-xs-6 col-sm-3 col-md-3"><h3><a href="/products">Products</a></h3><ul><li><a href="/products/elasticsearch">Elasticsearch</a></li><li><a href="/products/kibana">Kibana</a></li><li><a href="/products/logstash">Logstash</a></li><li><a href="/products/beats">Beats</a></li><li><a href="/cloud">Elastic Cloud</a></li><li><a href="/products/shield">Shield (Security)</a></li><li><a href="/products/watcher">Watcher (Alerting)</a></li><li><a href="/products/marvel">Marvel (Monitoring)</a></li><li><a href="/products/graph">Graph</a></li><li><a href="/products/reporting">Reporting</a></li><li><a href="/products/hadoop">ES-Hadoop</a></li></ul></div><div class="col-xs-6 col-sm-3 col-md-3"><h3>Resources</h3><ul><li><a href="/blog">Blog</a></li><li><a href="/community">Community</a></li><li><a href="/use-cases">Customers & Use Cases</a></li><li><a href="/guide">Documentation</a></li><li><a href="/elasticon">Elastic{ON} Events</a></li><li><a href="https://discuss.elastic.co/">Forums</a></li><li><a href="/community/meetups">Meetups</a></li><li><a href="https://support.elastic.co">Support Portal/Login</a></li><li><a href="/videos">Videos & Webinars</a></li><li><a href="/training">Training</a></li></ul></div><div class="col-xs-6 col-sm-3 col-md-3"><h3><a href="/about">About</a></h3><ul><li><a href="/about/careers">Careers</a></li><li><a href="/contact">Contact</a></li><li><a href="/about/leadership">Leadership</a></li><li><a href="/about/partners">Partners</a></li><li><a href="/about/press">Press</a></li></ul></div><div class="col-xs-6 col-sm-3 col-md-3"><h3>Language</h3><ul><li><a href="/">English</a></li><li><a href="/fr">French</a></li><li><a href="/de">German</a></li><li><a href="/jp">Japanese</a></li><li><a href="/kr">Korean</a></li></ul></div></div><div class="row social-icon"><div class="col-xs-12 col-sm-12 col-md-12"><ul><li class="facebook"><a target="_blank" id="footer_facebook" href="http://www.facebook.com/elastic.co" target="_blank"></a></li><li class="twitter"><a target="_blank" id="footer_twitter" href="https://www.twitter.com/elastic" target="_blank"></a></li><li class="linkedin"><a target="_blank" id="footer_linkedin" href="https://www.linkedin.com/company/elastic-co" target="_blank"></a></li><li class="xing"><a target="_blank" id="footer_xing" href="https://www.xing.com/companies/elastic.co" target="_blank"></a></li><li class="youtube"><a target="_blank" id="footer_youtube" href="https://www.youtube.com/user/elasticsearch" target="_blank"></a></li></ul></div></div><div class="row"><div class="col-xs-12 col-sm-12 col-md-12"><div class="copyright"><ul><li><a href="/legal/trademarks">Trademarks</a></li><li><a href="" legal="" terms-of-use"="">Terms of Use</a></li><li><a href="" legal="" privacy-policy"="">Privacy</a></li><li><a href="" legal="" privacy-and-cookie-policy"="">Cookie Policy</a></li><li><a href="/brand">Brand</a></li></ul><div class="copyright-content"><div class="footer-logo"><a href="#"><img src="/static/images/elastic-logo-H-full color.png" class="img-responsive"></a></div><div class="footer-text"><p>© 2016. All Rights Reserved - Elasticsearch</p><p>Elasticsearch is a trademark of Elasticsearch BV, registered in the U.S. and in other countries</p><p>Apache, Apache Lucene, Apache Hadoop, Hadoop, HDFS and the yellow elephant logo are trademarks of the <a href="http://www.apache.org/" target="_blank">Apache Software Foundation</a> in the United States and/or other countries.</p></div></div></div></div></div></div></footer><style type="text/css">
		
			.facebook{background:url("/assets/bltf66b1b8a624e81b2/facebook.svg") no-repeat;}		
		
			.twitter{background:url("/assets/blt0c27fbeba1f2b85b/twitter.svg") no-repeat;}		
		
			.linkedin{background:url("/assets/blt7890ae949fd3873f/linkedin.svg") no-repeat;}		
		
			.xing{background:url("/assets/blt0d0981773de2643c/xing.svg") no-repeat;}		
		
			.youtube{background:url("/assets/blt891f87ea1aa18977/youtube.svg") no-repeat;}		
		
	</style><script>
MktoForms2.loadForm("//app-lon02.marketo.com", "813-MAM-392", 1398,function(form){
  form.onSuccess(function(form){
    $('#mktoForm_1398').css('display','none');
    $('#subscribe-newsletter header').hide();
    $('#mktoForm_1398').siblings('.form_thanks').removeClass('hide')
    dataLayer.push({'event': 'mktoFormSubmit'});
      return false;
    });
});
</script><script src="/static/js/jquery.min.js"></script><script src="/static/js/bootstrap.min.js"></script><script src="/static/js/jquery.autocomplete.js"></script><script src="/static/js/script.js"></script></section></div><script type="text/javascript">
	var suggestionsUrl = "https://search.elastic.co/suggest";	
</script><script src="/static/js/jquery.cookie.js"></script><style></style><script type="text/javascript">
       $(document).ready(function(){
        $('.dropdown-btn').on('click', function(){
          myFunction();
        });
         function myFunction() {
            // document.getElementById("myDropdown").classList.toggle("show");
            $('#myDropdown').toggleClass('show');
        }

        // Close the dropdown menu if the user clicks outside of it
        $('body').on('click', function(event){
          if (!event.target.matches('.dropdown-btn')) {

            var dropdowns = $(".dropdown-content");
            var i;
            for (i = 0; i < dropdowns.length; i++) {
              var openDropdown = dropdowns[i];
              if (openDropdown.classList.contains('show')) {
                openDropdown.classList.remove('show');
              }
            }
          }
        });
       });
     </script>
            <script type="text/javascript" src="docs.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script type='text/javascript' src='https://google-code-prettify.googlecode.com/svn/loader/run_prettify.js'></script>

            </body>
        